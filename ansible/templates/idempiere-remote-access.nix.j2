# idempiere-remote-access.nix
# NixOS overlay module for cross-container database access
#
# Generated by Ansible when VILARA_REMOTE_ACCESS=true
# See: planning/idempiere-vilara-connector.md
#
# This module overrides idempiere-prerequisites.nix settings to:
#   - Listen on all interfaces (not just localhost)
#   - Allow connections from container network
#   - Open PostgreSQL port in firewall

{ lib, ... }:

{
  # Override PostgreSQL to listen on all interfaces
  # mkOverride 49 takes precedence over mkForce (which is mkOverride 50)
  services.postgresql.settings.listen_addresses = lib.mkOverride 49 "0.0.0.0";

  # Add pg_hba.conf rules for Vilara integration users
  # Uses mkAfter to append to existing authentication rules
  services.postgresql.authentication = lib.mkAfter ''
    # Vilara container access (generated by Ansible)
    # Allow idempiere_readonly and idempiere_readwrite from container network
    host    {{ db_name }}    idempiere_readonly     10.0.0.0/8       scram-sha-256
    host    {{ db_name }}    idempiere_readwrite    10.0.0.0/8       scram-sha-256
  '';

  # Open PostgreSQL port for container network access
  networking.firewall.allowedTCPPorts = [ {{ db_port }} ];
}
